dependencies {
    compileOnly "com.github.Anuken.Arc:arc-core:$mindustryVersion"
    compileOnly "com.github.Anuken.MindustryJitpack:core:$mindustryVersion"

    implementation project(":core")

    compileOnly project(":annotations")
    annotationProcessor project(":annotations")
}

ext {
    sdkRoot = System.getenv("ANDROID_HOME") ?: System.getenv("ANDROID_SDK_ROOT") ?: rootProject.ext.localProperties.get("sdkroot")
}

tasks.named("jar").configure {
    archiveFileName = "raw-${rootProject.ext.getOutputJar(project)}"
    doLast{
        var useandroid = rootProject.ext.localProperties.get("useandroid")
        println "Use android ${useandroid == null || useandroid == true}."
        if (useandroid == null || useandroid == true) {
            var jar = tasks.jar.archiveFile.get().asFile
            var dex = new File(jar.parent, rootProject.ext.getOutputJar(project))

            var classpath = (configurations.compileClasspath.asList()
                    + configurations.runtimeClasspath.asList()
                    + [new File("$sdkRoot/platforms/android-30.0.1/android.jar")])

            var dependencies = ""

            if(!sdkRoot || !new File(sdkRoot).exists()) throw new GradleException("No valid Android SDK found. Ensure that ANDROID_HOME is set to your Android SDK directory.");

            def platformRoot = new File("$sdkRoot/platforms/").listFiles().sort().reverse().find{ f -> new File(f, "android.jar").exists()}

            if(!platformRoot) throw new GradleException("No android.jar found. Ensure that you have an Android platform installed.")

            exec{
                workingDir dex.parent

                for(def path : classpath){
                    dependencies += "--classpath "
                    dependencies += path.path + " "
                }

                println "d8 $dependencies --min-api 14 --output ${dex} ${jar}"

                println dex.absolutePath
                println jar.absolutePath
                "d8 $dependencies --min-api 14 --output ${dex} ${jar}"
                        .execute(null, projectDir).waitForProcessOutput(System.out, System.err)
            }
        }
    }
}